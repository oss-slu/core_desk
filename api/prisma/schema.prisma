// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model user {
  id        String @id @default(cuid())
  email     String @unique
  firstName String
  lastName  String

  logs  logs[]
  shops UserShop[]
  jobs  Job[]

  admin  Boolean @default(false)
  suspended Boolean @default(false)
  suspensionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model logs {
  id      String  @id @default(cuid())
  type    LogType
  message String?
  from String? @db.MediumText
  to String? @db.MediumText

  user   user?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String?

  shop   Shop?   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId String?

  job    Job?    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId String?

  jobItem JobItem? @relation(fields: [jobItemId], references: [id], onDelete: Cascade)
  jobItemId String?

  resource Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  resourceId String?

  resourceImage ResourceImage? @relation(fields: [resourceImageId], references: [id], onDelete: Cascade)
  resourceImageId String?

  material Material? @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId String?

  materialImage MaterialImage? @relation(fields: [materialImageId], references: [id], onDelete: Cascade)
  materialImageId String?

  resourceType ResourceType? @relation(fields: [resourceTypeId], references: [id], onDelete: Cascade)
  resourceTypeId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LogType {
  USER_LOGIN
  USER_CREATED
  SHOP_CREATED
  USER_CONNECTED_TO_SHOP
  USER_DISCONNECTED_FROM_SHOP
  USER_SHOP_ROLE_CHANGED
  USER_PROMOTED_TO_ADMIN
  USER_DEMOTED_FROM_ADMIN
  USER_SUSPENSION_APPLIED
  USER_SUSPENSION_REMOVED
  USER_SUSPENSION_CHANGED
  JOB_CREATED
  JOB_MODIFIED
  JOB_DELETED
  JOB_STATUS_CHANGED
  JOB_ITEM_CREATED
  JOB_ITEM_DELETED
  JOB_ITEM_MODIFIED
  JOB_ITEM_STATUS_CHANGED
  RESOURCE_CREATED
  RESOURCE_MODIFIED
  RESOURCE_DELETED
  RESOURCE_IMAGE_CREATED
  RESOURCE_IMAGE_MODIFIED
  RESOURCE_IMAGE_DELETED
  RESOURCE_TYPE_CREATED
  RESOURCE_TYPE_MODIFIED
  RESOURCE_TYPE_DELETED
  MATERIAL_CREATED
  MATERIAL_MODIFIED
  MATERIAL_DELETED
  MATERIAL_MSDS_UPLOADED
  MATERIAL_TDS_UPLOADED
  MATERIAL_IMAGE_CREATED
  MATERIAL_IMAGE_MODIFIED
  MATERIAL_IMAGE_DELETED
}

model UserShop {
  id     String @id @default(cuid())
  user   user   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId String

  accountType AccountType @default(CUSTOMER)
  accountTitle String?

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AccountType {
  CUSTOMER
  OPERATOR
  ADMIN
  INSTRUCTOR
}

model Shop {
  id          String  @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  website     String?
  description String? @db.MediumText
  imageUrl    String?

  color Color?

  logs  logs[]
  users UserShop[]
  jobs  Job[]

  resourceTypes ResourceType[]
  resources Resource[]

  materials Material[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resource {
  id          String  @id @default(cuid())
  title       String
  description String? @db.MediumText
  images      ResourceImage[]
  public      Boolean @default(false)

  primaryCategory String?
  secondaryCategory String?

  resourceType ResourceType @relation(fields: [resourceTypeId], references: [id])
  resourceTypeId String

  shop   Shop   @relation(fields: [shopId], references: [id])
  shopId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  active Boolean @default(true)

  quantity Int?
  quantityPublic Boolean @default(true)

  costPerUnit Float?
  fixedCost Float?
  costPerTime Float?
  materialLabel String?
  costPerProcessingTime Float?
  costingPublic Boolean @default(true)

  userSuppliedMaterial SuppliedMaterialLevels @default(NEVER)

  jobItems JobItem[]
  jobs Job[]

  logs  logs[]

  additionalCostItems AdditionalCostLineItem[]
}

model Material {
  id          String  @id @default(cuid())
  title       String
  description String? @db.MediumText
  manufacturer String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active Boolean @default(true)

  jobItems JobItem[]
  jobs Job[]

  shopId String
  shop Shop @relation(fields: [shopId], references: [id])

  costPerUnit Float?
  unitDescriptor String?
  costPublic Boolean @default(true)

  resourceTypeId String
  resourceType ResourceType @relation(fields: [resourceTypeId], references: [id])

  images MaterialImage[]

  msdsFileKey String?
  msdsFileUrl String?
  msdsFileName String?
  msdsFileType String?

  tdsFileKey String?
  tdsFileUrl String?
  tdsFileName String?
  tdsFileType String?

  logs  logs[]

  additionalCostItems AdditionalCostLineItem[]
}

model MaterialImage {
  id          String  @id @default(cuid())

  fileKey String
  fileUrl String
  fileName String
  fileType String

  description String?

  active Boolean @default(true)

  material Material @relation(fields: [materialId], references: [id])
  materialId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs  logs[]
}

model ResourceImage {
  id          String  @id @default(cuid())

  fileKey String
  fileUrl String
  fileName String
  fileType String

  description String?

  active Boolean @default(true)

  resource Resource @relation(fields: [resourceId], references: [id])
  resourceId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs  logs[]
}

// enum ResourceType {
//   OTHER
//   INSTRUMENT
//   TOOL
//   PRINTER
//   PRINTER_3D
//   LASER_CUTTER
//   CNC
// }

model ResourceType {
  id          String  @id @default(cuid())
  title       String
  description String? @db.MediumText

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active Boolean @default(true)

  shopId String
  shop Shop @relation(fields: [shopId], references: [id])

  resources Resource[]
  jobItems JobItem[]
  jobs Job[]
  materials Material[]

  logs  logs[]

  additionalCostItems AdditionalCostLineItem[]
}

enum SuppliedMaterialLevels {
  ALWAYS
  SOMETIMES
  NEVER
  SPECIAL
}

enum Color {
  RED
  BLUE
  GREEN
  YELLOW
  ORANGE
  PURPLE
  PINK
  TEAL
}

model Job {
  id          String  @id @default(cuid())
  title       String
  description String? @db.MediumText
  imageUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shop   Shop   @relation(fields: [shopId], references: [id])
  shopId String

  user   user   @relation(fields: [userId], references: [id])
  userId String

  material Material? @relation(fields: [materialId], references: [id])
  materialId String?

  resourceType ResourceType? @relation(fields: [resourceTypeId], references: [id])
  resourceTypeId String?

  resource Resource? @relation(fields: [resourceId], references: [id])
  resourceId String?

  dueDate DateTime?

  additionalCostOverride Boolean @default(false) /// If true, the additional cost will be used _instead_ of the calculated cost. If false, it will be used in addition.

  additionalCosts AdditionalCostLineItem[]

  logs  logs[]
  items JobItem[]

  status ProgressStatus @default(NOT_STARTED)
}

model AdditionalCostLineItem {
  id          String  @id @default(cuid())

  resourceTypeId String?
  resourceType ResourceType? @relation(fields: [resourceTypeId], references: [id])

  resourceId String?
  resource Resource? @relation(fields: [resourceId], references: [id])

  materialId String?
  material Material? @relation(fields: [materialId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unitQty Float?
  timeQty Float?
  materialQty Float?
  processingTimeQty Float?

  active Boolean @default(true)

  job Job @relation(fields: [jobId], references: [id])
  jobId String
}

model JobItem {
  id          String  @id @default(cuid())
  title       String
  status     ProgressStatus @default(NOT_STARTED)

  fileKey String
  fileUrl String
  fileName String
  fileType String

  resource Resource? @relation(fields: [resourceId], references: [id])
  resourceId String?

  resourceType ResourceType? @relation(fields: [resourceTypeId], references: [id])
  resourceTypeId String?

  material Material? @relation(fields: [materialId], references: [id])
  materialId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  active Boolean @default(true)

  processingTimeQty Float?
  timeQty Float?
  unitQty Float?
  materialQty Float?

  jobId String
  job Job @relation(fields: [jobId], references: [id])
  logs logs[]
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  WAITING_FOR_PICKUP
  WAITING_FOR_PAYMENT
  CANCELLED
  WONT_DO
  WAITING
}
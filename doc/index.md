# Overall documentation

## Codebase Organization

The React frontend lives in the `app/` directory, everything else is based in the root. `index.js` is the entrypoint for the API, and uses file-based routing to route requests to the appropriate file living in the `/routes` directory. The API is built using Express.js. The file-based router is implemented on the `/api/*` path, so all API requests going to the router folder should be prefixed with `/api/`. The API is pretty self-documenting based on the file structure.

Data fetching is done primarily with the `authFetch` method from `/app/src/util/url.js`. This method is a wrapper around the `fetch` API that automatically attaches the JWT token to the request headers. It is otherwise called the same way as `fetch`. It returns the fetch promise. All data fetching should happen in hooks living in the `/app/src/hooks` directory. Hooks should all export `{ loading, error, refetch, data }` where data is the high-level data object. It should be named using the singular noun resource it fetches, e.g. `user`, `shop`, `project` etc. All hooks should be named `use{Resource}` where the resource is the same as data object's name, and the hook file should be named `use{Resource}.js`.

For the frontend, we use the React UI kit `tabler-react-2`.

Components live in the `/app/src/components` directory, and should be named using the noun of the resource they represent, e.g. `User`, `Shop`, `Shops`, `Project` etc. Components should be named using the PascalCase convention, and should be named the same as the file they live in. Components should be organized into folders based on the resource they represent, e.g. `/app/src/components/User`, `/app/src/components/Shop`, `/app/src/components/Project` etc. If components need custom CSS, the CSS file should be named the same as the component, but with a `.module.css` extension and live in the same folder. Component files should have the `.jsx` extension.

### Authentication

Authentication is handled on the frontend using the `authFetch` function, and should almost always be abstracted away from the developer. The API expects the JWT token to be in the `Authorization: bearer {token}` header, and will return a 401 if the token is invalid or missing. On the server, the auth flow is handled by a middleware that checks the JWT token, fetches the user object from the database, and attaches it to the request object. This user object is then available to all subsequent middleware and route handlers. Please note that you may not want to send the full user object to the client, as it may contain sensitive information. Instead, you should send only the necessary information to the client. This middleware function is called `verifyAuth` and is imported from `/app/util/verifyAuth.js`. An authenticated route should look like this:

```javascript
import { verifyAuth } from "../../util/verifyAuth.js";

export const get = [
  verifyAuth,
  (req, res) => {
    res.json({
      user: {
        id: req.user.id,
      },
    });
  },
];
```

## Auth flow

We use SAML to log into the app via SLU SSO. The configuration for saml lives in the `/config/saml-config.js` file, and uses the cert file in the root directory `/okta.cert`.

The auth flow API, accessible at `/api/auth/*` is responsible for handling the SAML auth flow and converting sessions into JWTs that are supplied to the client.

After login, the user is redirected back to the `/assertion` endpoint, which affiliates the user with the user's object living in our databse (or creates it if a user does not already exist). This then redirects the user to the frontend url with the JWT in the query string. From here, the frontend extracts the JWT (in the `useAuth` hook), stores it in local storage, and deletes it from the query string.

The auth flow has the following endpoints:

### GET `/api/auth/login`

This endpoint returns a JSON object with a `url` key that contains the URL to redirect the user to for SAML login. This endpoint does not require any auth or additional headers.

#### Response:

```json
{
  "url": "https://---.okta.com/app/dev----tform2_1/exkkf---Ogwg5d7/sso/saml"
}
```

### GET `/api/auth/me`

This endpoint returns a JSON object with a `user` key that contains the user's ID (This is generated by our application, not supplied by OKTA), the user's email, firstName, and lastName. This endpoint requires a valid JWT in the `Authorization` header.

#### Response:

```json
{
  "user": {
    "id": "cm2ceomc20000qrdmvld5p3s6",
    "email": "jack.crane@slu.edu",
    "firstName": "Jack",
    "lastName": "Crane"
  }
}
```

This information is exposed in the frontend by the `useAuth` hook, which returns the user object:

```javascript
const { user } = useAuth();
/*
> {
>   "id":"cm2ceomc20000qrdmvld5p3s6",
>   "email":"jack.crane@slu.edu",
>   "firstName":"Jack",
>   "lastName":"Crane"
> }
*/
```

## Shops

Shops are centers that host printers or other equipment. They are the highest level of "campus" in the application.

### `/api/shop`

#### GET

This endpoint returns a JSON object with a `shops` key that contains an array of shop objects. This endpoint requires a valid JWT in the `Authorization` header.

```json
{
  "shops": [
    {
      "id": "cm2dz5xdz0002665mvd5j491p",
      "name": "SLU Center for Additive Manufacturing",
      "address": null,
      "phone": null,
      "email": "slu.cam@slu.edu",
      "description": null,
      "imageUrl": null
    }
  ],
  "meta": {
    "total": 1,
    "count": 1,
    "offset": 0
  }
}
```

}

#### POST

This endpoint creates a new shop. It requires a valid JWT in the `Authorization` header, and a JSON object in the request body with the following keys:

- `name` (string): The name of the shop
- `address` (string?): The address of the shop
- `phone` (string?): The phone number of the shop
- `email` (string?): The email of the shop
- `website` (string?): The website of the shop
- `description` (string?): A description of the shop
- `imageUrl` (string?): A URL to an image of the shop

The API will respond with a JSON object containing the content of a traditional GET request to the shop endpoint with the new shop included, the standard meta object, and a `newShop` key that contains the new shop object.

##### Request body:

```json
{
  "name": "Academic Tech Commons at Pius III Memorial Library",
  "email": "atc@slu.edu",
  "phone": "555-555-5555",
  "address": "3650 Lindell Blvd, St. Louis, Missouri",
  "description": "3d printers and more advanced printers in the ATC in the library's first floor",
  "website": "https://www.slu.edu/library/services/academic-technology-commons/index.php",
  "imageUrl": "https://www.slu.edu/library/services/academic-technology-commons/-img/academic-technology-commons-01.jpg"
}
```

##### Response:

```json
{
  "newShop": {
    "id": "cm2exf9h60000lrscxidsipw0",
    "name": "Academic Tech Commons at Pius III Memorial Library",
    "address": "3650 Lindell Blvd, St. Louis, Missouri",
    "phone": "555-555-5555",
    "email": "atc@slu.edu",
    "description": "3d printers and more advanced printers in the ATC in the library's first floor",
    "imageUrl": "https://www.slu.edu/library/services/academic-technology-commons/-img/academic-technology-commons-01.jpg"
  },
  "shops": [
    {
      "id": "cm2dz5xdz0002665mvd5j491p",
      "name": "SLU Center for Additive Manufacturing",
      "address": null,
      "phone": null,
      "email": "slu.cam@slu.edu",
      "description": null,
      "imageUrl": null
    },
    {
      "id": "cm2exf9h60000lrscxidsipw0",
      "name": "Academic Tech Commons at Pius III Memorial Library",
      "address": "3650 Lindell Blvd, St. Louis, Missouri",
      "phone": "555-555-5555",
      "email": "atc@slu.edu",
      "description": "3d printers and more advanced printers in the ATC in the library's first floor",
      "imageUrl": "https://www.slu.edu/library/services/academic-technology-commons/-img/academic-technology-commons-01.jpg"
    }
  ],
  "meta": {
    "total": 2,
    "count": 2,
    "offset": 0
  }
}
```
